<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 900px;
            min-height: 600px;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        #loginSection {
            padding: 40px;
            text-align: center;
        }

        #loginSection h2 {
            color: #1f2937;
            font-size: 24px;
            margin-bottom: 32px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 24px;
        }

        input {
            width: 100%;
            max-width: 400px;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        input:focus {
            outline: none;
            border-color: #4f46e5;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        #chatSection {
            display: none;
            height: 600px;
            display: flex;
            flex-direction: row;
        }

        .chat-sidebar {
            width: 300px;
            border-right: 1px solid #e5e7eb;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
        }

        .chat-sidebar-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
        }

        .chat-sidebar-header h3 {
            color: #1f2937;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .refresh-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 10px 16px;
            font-size: 14px;
            min-width: auto;
            width: 100%;
        }

        .refresh-button:hover {
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
        }

        #chatList {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .main-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #f8fafc;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .chat-header h3 {
            color: #1f2937;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        #chatTitle {
            color: #1f2937;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .user-id-section {
            background: #f1f5f9;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .user-id-section h3 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        #myUserId {
            background: #1e293b;
            color: #f1f5f9;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            display: inline-block;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .user-id-section p {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }

        #chatbox {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .system {
            background: #dbeafe;
            color: #1e40af;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-size: 14px;
            border-radius: 20px;
        }

        .sent {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .received {
            background: #f1f5f9;
            color: #1e293b;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            align-self: center;
            max-width: 90%;
            text-align: center;
            border: 1px solid #fecaca;
        }

        .message-input-area {
            background: #f8fafc;
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
        }

        .recipient-input {
            margin-bottom: 12px;
        }

        .recipient-input input {
            max-width: 200px;
            font-size: 14px;
            padding: 12px 16px;
        }

        .message-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .message-input-container input {
            flex: 1;
            margin: 0;
        }

        .message-input-container button {
            padding: 16px 24px;
            min-width: auto;
        }

        /* Scrollbar styling */
        #chatbox::-webkit-scrollbar {
            width: 6px;
        }

        #chatbox::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        #chatbox::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #chatbox::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 16px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            #loginSection {
                padding: 30px 20px;
            }

            #chatSection {
                flex-direction: column;
            }

            .chat-sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            .message {
                max-width: 85%;
            }

            .message-input-container {
                flex-direction: column;
            }

            .message-input-container input,
            .message-input-container button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Secure Messenger</h1>
            <p>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º</p>
        </div>
        
        <div id="loginSection">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç</h2>
            <div class="input-group">
                <input type="text" id="usernameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
            </div>
            <button onclick="login()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É</button>
        </div>

        <div id="chatSection">
            <div class="chat-sidebar">
                <div class="chat-sidebar-header">
                    <h3>–ú–æ–∏ —á–∞—Ç—ã</h3>
                    <button class="refresh-button" onclick="messenger.loadChats()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="chatList"></div>
            </div>

            <div class="main-chat-area">
                <div class="chat-header">
                    <h3 id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    
                    <div class="user-id-section">
                        <h3>–í–∞—à ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</h3>
                        <code id="myUserId"></code>
                        <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º ID —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</p>
                    </div>
                </div>
                
                <div id="chatbox"></div>
                
                <div class="message-input-area">
                    <div class="recipient-input">
                        <input type="text" id="recipientInput" placeholder="ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
                    </div>
                    
                    <div class="message-input-container">
                        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/libsodium-wrappers-sumo@0.7.11/dist/sodium-sumo.min.js"></script>
    <script>
        class SecureMessenger {
            constructor() {
                this.sodium = null;
                this.socket = null;
                this.myUserId = null;
                this.myUsername = null;
                this.identityKeyPair = null;
                this.signedPreKeyPair = null;
                this.signedPreKeySignature = null;
                this.sessionKeys = {};
                this.serverUrl = 'wss://secure-messenger-backend-xjvb.onrender.com';
                this.currentChat = null;
                this.chats = [];
                this.messages = {};
                
                // –ù–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø—É–ª–∞ –∫–ª—é—á–µ–π
                this.keyPool = {}; // { userId: [key1, key2, ...] }
                this.usedKeys = new Set(); // track used key IDs
                this.keyPoolSize = 1000; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π –≤ –ø—É–ª–µ
            }

            async init() {
                try {
                    this.sodium = await window.sodium;
                    console.log("Libsodium –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ");
                    this.showSystemMessage("üîê –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞", "system");
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ libsodium:", error);
                    this.showSystemMessage("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "error");
                }
            }

            async login() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const usernameInput = document.getElementById('usernameInput');
                const currentUserSpan = document.getElementById('currentUser');
                const myUserIdCode = document.getElementById('myUserId');
                const loginSection = document.getElementById('loginSection');
                const chatSection = document.getElementById('chatSection');
                
                if (!usernameInput || !currentUserSpan || !myUserIdCode || !loginSection || !chatSection) {
                    console.error("HTML elements not found!");
                    this.showSystemMessage("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞", "error");
                    return;
                }
                
                const username = usernameInput.value.trim();
                if (!username) {
                    this.showSystemMessage("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "error");
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
                const serverAvailable = await this.checkServerConnection();
                if (!serverAvailable) {
                    this.showSystemMessage("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.", "error");
                    return;
                }

                this.myUsername = username;
                this.myUserId = username + '_' + Math.random().toString(36).substr(2, 8);
                
                document.getElementById('currentUser').textContent = username;
                document.getElementById('myUserId').textContent = this.myUserId;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('chatSection').style.display = 'flex';

                this.showSystemMessage("üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Secure Messenger!", "system");
                this.showSystemMessage("üîë –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–ª—é—á–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...", "system");

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É–ª –∫–ª—é—á–µ–π –≤–º–µ—Å—Ç–æ X3DH
                await this.generateKeyPool();
                this.connectWebSocket();
                
                setTimeout(() => this.loadChats(), 1000);
                
                this.showSystemMessage("‚úÖ –ì–æ—Ç–æ–≤ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É –æ–±—â–µ–Ω–∏—é!", "system");
                this.showSystemMessage("üìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à ID –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É", "system");
            }

            async checkServerConnection() {
                try {
                    const API_BASE = this.serverUrl.replace('wss://', 'https://').replace('/ws', '');
                    const response = await fetch(`${API_BASE}/health`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const health = await response.json();
                        this.showSystemMessage(`‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω. –°—Ç–∞—Ç—É—Å: ${health.status}`, "system");
                        return true;
                    } else {
                        this.showSystemMessage("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "error");
                        return false;
                    }
                } catch (error) {
                    this.showSystemMessage("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É", "error");
                    return false;
                }
            }

            async generateKeyPool() {
                try {
                    this.showSystemMessage("üîë –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø—É–ª –∫–ª—é—á–µ–π...", "system");
                    
                    const pool = [];
                    for (let i = 0; i < this.keyPoolSize; i++) {
                        const key = this.sodium.crypto_aead_xchacha20poly1305_ietf_keygen();
                        pool.push({
                            id: i,
                            key: key,
                            used: false
                        });
                    }
                    
                    this.keyPool[this.myUserId] = pool;
                    this.showSystemMessage(`‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${this.keyPoolSize} –∫–ª—é—á–µ–π`, "system");
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É–ª –∫–ª—é—á–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    await this.uploadKeyPool();
                    
                } catch (error) {
                    console.error("Key pool generation error:", error);
                    this.showSystemMessage("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π", "error");
                }
            }

            async uploadKeyPool() {
                try {
                    const poolData = this.keyPool[this.myUserId].map(item => ({
                        id: item.id,
                        key: this.sodium.to_base64(item.key)
                    }));

                    const API_BASE = this.serverUrl.replace('wss://', 'https://').replace('/ws', '');
                    const response = await fetch(`${API_BASE}/keypool/upload/${this.myUserId}`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ keys: poolData }),
                        mode: 'cors'
                    });

                    if (response.ok) {
                        this.showSystemMessage("‚úÖ –ü—É–ª –∫–ª—é—á–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä", "system");
                    }
                } catch (error) {
                    console.error("Key pool upload error:", error);
                }
            }

            async downloadKeyPool(userId) {
                try {
                    const API_BASE = this.serverUrl.replace('wss://', 'https://').replace('/ws', '');
                    const response = await fetch(`${API_BASE}/keypool/download/${userId}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const pool = data.keys.map(item => ({
                            id: item.id,
                            key: this.sodium.from_base64(item.key),
                            used: false
                        }));
                        
                        this.keyPool[userId] = pool;
                        this.showSystemMessage(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω –ø—É–ª –∫–ª—é—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`, "system");
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error("Key pool download error:", error);
                    return false;
                }
            }

            encryptMessageWithRandomKey(plaintext, userId) {
                try {
                    const pool = this.keyPool[userId];
                    if (!pool || pool.length === 0) {
                        throw new Error("No keys available for encryption");
                    }

                    // –ò—â–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á
                    const availableKeys = pool.filter(key => !key.used);
                    if (availableKeys.length === 0) {
                        throw new Error("All keys have been used");
                    }

                    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á
                    const randomIndex = Math.floor(Math.random() * availableKeys.length);
                    const selectedKey = availableKeys[randomIndex];
                    
                    // –ü–æ–º–µ—á–∞–µ–º –∫–ª—é—á –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
                    selectedKey.used = true;
                    this.usedKeys.add(selectedKey.id);

                    // –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const nonce = this.sodium.randombytes_buf(this.sodium.crypto_aead_xchacha20poly1305_ietf_NPUBBYTES);
                    const ciphertext = this.sodium.crypto_aead_xchacha20poly1305_ietf_encrypt(
                        plaintext,
                        null,
                        null,
                        nonce,
                        selectedKey.key
                    );

                    // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º nonce + ciphertext + key ID
                    const combined = new Uint8Array(nonce.length + ciphertext.length + 4);
                    combined.set(nonce);
                    combined.set(ciphertext, nonce.length);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º ID –∫–ª—é—á–∞ (4 –±–∞–π—Ç–∞)
                    const keyIdBytes = new Uint8Array(new Uint32Array([selectedKey.id]).buffer);
                    combined.set(keyIdBytes, nonce.length + ciphertext.length);

                    return this.sodium.to_base64(combined);
                    
                } catch (error) {
                    console.error("Encryption error:", error);
                    throw error;
                }
            }

            decryptMessageWithKeyId(encodedMessage, userId) {
                try {
                    const combined = this.sodium.from_base64(encodedMessage);
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
                    const nonce = combined.slice(0, this.sodium.crypto_aead_xchacha20poly1305_ietf_NPUBBYTES);
                    const ciphertext = combined.slice(
                        this.sodium.crypto_aead_xchacha20poly1305_ietf_NPUBBYTES, 
                        combined.length - 4
                    );
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∫–ª—é—á–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –±–∞–π—Ç–∞)
                    const keyIdBytes = combined.slice(combined.length - 4);
                    const keyId = new Uint32Array(keyIdBytes.buffer)[0];
                    
                    // –ù–∞—Ö–æ–¥–∏–º –∫–ª—é—á –ø–æ ID
                    const pool = this.keyPool[userId];
                    if (!pool) {
                        throw new Error("Key pool not found");
                    }
                    
                    const keyData = pool.find(key => key.id === keyId);
                    if (!keyData) {
                        throw new Error(`Key with ID ${keyId} not found`);
                    }

                    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º
                    const decrypted = this.sodium.crypto_aead_xchacha20poly1305_ietf_decrypt(
                        null,
                        ciphertext,
                        null,
                        nonce,
                        keyData.key
                    );
                    
                    return this.sodium.to_string(decrypted);
                    
                } catch (error) {
                    console.error("Decryption error:", error);
                    throw error;
                }
            }

            async sendMessage() {
                const recipientId = document.getElementById('recipientInput').value.trim();
                const messageText = document.getElementById('messageInput').value.trim();

                if (!recipientId) {
                    this.showSystemMessage("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è", "error");
                    return;
                }

                if (!messageText) {
                    this.showSystemMessage("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", "error");
                    return;
                }

                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—É–ª –∫–ª—é—á–µ–π –ø–æ–ª—É—á–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç
                    if (!this.keyPool[recipientId]) {
                        this.showSystemMessage("üì• –ó–∞–≥—Ä—É–∂–∞—é –∫–ª—é—á–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è...", "system");
                        const success = await this.downloadKeyPool(recipientId);
                        if (!success) {
                            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è");
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ —Å–ø–∏—Å–æ–∫
                        this.addChatToList(recipientId);
                    }

                    // –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const encrypted = this.encryptMessageWithRandomKey(messageText, recipientId);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
                    this.socket.send(JSON.stringify({
                        to: recipientId,
                        from: this.myUserId,
                        encrypted_message: encrypted
                    }));

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                    this.saveMessageToHistory(recipientId, {
                        sender: this.myUserId,
                        text: messageText,
                        timestamp: new Date(),
                        type: 'sent'
                    });

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —É —Å–µ–±—è
                    this.showMessage("–í—ã", messageText, "sent");
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                    this.updateChatList();
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    document.getElementById('messageInput').value = '';
                    
                    // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    document.getElementById('messageInput').focus();

                } catch (error) {
                    console.error("Send error:", error);
                    this.showSystemMessage(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`, "error");
                }
            }

            async handleIncomingMessage(messageData) {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–∏ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–±—Ä–∞—Ç–Ω–æ)
                if (messageData.from === this.myUserId) return;

                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—É–ª –∫–ª—é—á–µ–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç
                    if (!this.keyPool[messageData.from]) {
                        this.showSystemMessage("üì• –ó–∞–≥—Ä—É–∂–∞—é –∫–ª—é—á–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è...", "system");
                        const success = await this.downloadKeyPool(messageData.from);
                        if (!success) {
                            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è");
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ —Å–ø–∏—Å–æ–∫
                        this.addChatToList(messageData.from);
                    }

                    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º
                    const decrypted = this.decryptMessageWithKeyId(
                        messageData.encrypted_message, 
                        messageData.from
                    );
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                    this.saveMessageToHistory(messageData.from, {
                        sender: messageData.from,
                        text: decrypted,
                        timestamp: new Date(),
                        type: 'received'
                    });
                    
                    this.showMessage(messageData.from, decrypted, "received");
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                    this.updateChatList();
                    
                    // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    this.playNotificationSound();
                    
                } catch (error) {
                    console.error("Message handling error:", error);
                    this.showSystemMessage(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏: ${error.message}`, "error");
                }
            }

            connectWebSocket() {
                try {
                    this.socket = new WebSocket(`${this.serverUrl}/${this.myUserId}`);
                    
                    this.socket.onopen = () => {
                        this.showSystemMessage("‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "system");
                    };
                    
                    this.socket.onmessage = async (event) => {
                        try {
                            const messageData = JSON.parse(event.data);
                            await this.handleIncomingMessage(messageData);
                        } catch (error) {
                            console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                            this.showSystemMessage("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è", "error");
                        }
                    };
                    
                    this.socket.onclose = () => {
                        this.showSystemMessage("üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...", "system");
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };
                    
                    this.socket.onerror = (error) => {
                        console.error("WebSocket error:", error);
                        this.showSystemMessage("‚ùå –û—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
                    };
                    
                } catch (error) {
                    console.error("WebSocket connection error:", error);
                    this.showSystemMessage("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
                }
            }

            async loadChats() {
                try {
                    this.showSystemMessage("üìã –ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤...", "system");
                    
                    const API_BASE = this.serverUrl.replace('wss://', 'https://').replace('/ws', '');
                    const response = await fetch(`${API_BASE}/chats/${this.myUserId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        this.chats = await response.json();
                        this.renderChatList();
                        this.showSystemMessage("‚úÖ –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω", "system");
                    } else {
                        this.showSystemMessage("‚ÑπÔ∏è –ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç", "system");
                        this.chats = [];
                        this.renderChatList();
                    }
                    
                } catch (error) {
                    console.error("Error loading chats:", error);
                    this.showSystemMessage("‚ÑπÔ∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤", "system");
                    this.chats = [];
                    this.renderChatList();
                }
            }

            renderChatList() {
                const chatList = document.getElementById('chatList');
                if (!chatList) return;

                if (this.chats.length === 0) {
                    chatList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #64748b;">
                            <p>–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                            <p style="font-size: 12px; margin-top: 8px;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
                        </div>
                    `;
                    return;
                }

                chatList.innerHTML = this.chats.map(chat => `
                    <div class="chat-item" onclick="messenger.openChat('${chat.other_user_id}')" 
                         style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;"
                         onmouseover="this.style.background='#f1f5f9'" 
                         onmouseout="this.style.background='transparent'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #1f2937;">${chat.other_user_id}</strong>
                            <span style="font-size: 12px; color: #64748b;">${this.formatTime(chat.last_message_time)}</span>
                        </div>
                        <p style="margin: 4px 0 0 0; font-size: 14px; color: #64748b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${chat.last_message_preview || '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}
                        </p>
                    </div>
                `).join('');
            }

            addChatToList(userId) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —á–∞—Ç–∞
                if (!this.chats.some(chat => chat.other_user_id === userId)) {
                    this.chats.unshift({
                        other_user_id: userId,
                        last_message_time: new Date().toISOString(),
                        last_message_preview: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
                    });
                    this.renderChatList();
                }
            }

            updateChatList() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
                if (this.currentChat) {
                    const chat = this.chats.find(c => c.other_user_id === this.currentChat);
                    if (chat) {
                        chat.last_message_time = new Date().toISOString();
                        this.renderChatList();
                    }
                }
            }

            async openChat(userId) {
                this.currentChat = userId;
                document.getElementById('recipientInput').value = userId;
                document.getElementById('chatTitle').textContent = `–ß–∞—Ç —Å ${userId.split('_')[0]}`;
                
                // –û—á–∏—â–∞–µ–º —á–∞—Ç
                this.clearChat();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                await this.loadChatHistory(userId);
                
                this.showSystemMessage(`üí¨ –û—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å ${userId.split('_')[0]}`, "system");
            }

            async loadChatHistory(userId) {
                try {
                    this.showSystemMessage("üïí –ó–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π...", "system");
                    
                    const API_BASE = this.serverUrl.replace('wss://', 'https://').replace('/ws', '');
                    const response = await fetch(`${API_BASE}/messages/${this.myUserId}/${userId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const messages = await response.json();
                        
                        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                        this.messages[userId] = [];
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
                        messages.reverse().forEach(msg => {
                            this.saveMessageToHistory(userId, {
                                sender: msg.sender_id,
                                text: msg.encrypted_content, // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
                                timestamp: new Date(msg.timestamp),
                                type: msg.sender_id === this.myUserId ? 'sent' : 'received'
                            });
                            
                            const displayText = msg.sender_id === this.myUserId ? 
                                `–í—ã: ${msg.encrypted_content}` : 
                                `${msg.sender_id}: ${msg.encrypted_content}`;
                            
                            this.showMessage(
                                msg.sender_id === this.myUserId ? "–í—ã" : msg.sender_id,
                                msg.encrypted_content,
                                msg.sender_id === this.myUserId ? 'sent' : 'received'
                            );
                        });
                        
                        this.showSystemMessage("‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞", "system");
                    }
                    
                } catch (error) {
                    console.error("Error loading chat history:", error);
                    this.showSystemMessage("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π", "error");
                }
            }

            saveMessageToHistory(userId, message) {
                if (!this.messages[userId]) {
                    this.messages[userId] = [];
                }
                this.messages[userId].push(message);
            }

            showSystemMessage(text, type) {
                this.addMessageToChatbox("–°–∏—Å—Ç–µ–º–∞", text, type);
            }

            showMessage(sender, text, type) {
                this.addMessageToChatbox(sender, text, type);
            }

            addMessageToChatbox(sender, text, cssClass) {
                const chatbox = document.getElementById('chatbox');
                const messageElement = document.createElement('div');
                messageElement.className = `message ${cssClass}`;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const formattedText = this.formatMessage(text);
                const displayName = sender === this.myUserId ? "–í—ã" : sender;
                
                messageElement.innerHTML = `<strong>${displayName}:</strong> ${formattedText}`;
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
                messageElement.style.opacity = '0';
                messageElement.style.transform = 'translateY(10px)';
                messageElement.style.transition = 'all 0.3s ease';
                
                chatbox.appendChild(messageElement);
                chatbox.scrollTop = chatbox.scrollHeight;
                
                // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ
                setTimeout(() => {
                    messageElement.style.opacity = '1';
                    messageElement.style.transform = 'translateY(0)';
                }, 10);
            }

            clearChat() {
                const chatbox = document.getElementById('chatbox');
                if (chatbox) {
                    chatbox.innerHTML = '';
                }
            }

            formatMessage(text) {
                // –ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
                return text
                    .replace(/\n/g, '<br>')
                    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: inherit; text-decoration: underline;">$1</a>');
            }

            formatTime(date) {
                if (!(date instanceof Date)) {
                    date = new Date(date);
                }
                return date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }

            playNotificationSound() {
                // –ü—Ä–æ—Å—Ç–æ–π –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                try {
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);
                    
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.1;
                    
                    oscillator.start();
                    oscillator.stop(context.currentTime + 0.1);
                } catch (error) {
                    console.log("Audio not supported");
                }
            }

            copyUserId() {
                navigator.clipboard.writeText(this.myUserId).then(() => {
                    this.showSystemMessage("‚úÖ ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞", "system");
                }).catch(err => {
                    this.showSystemMessage("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID", "error");
                });
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
        const messenger = new SecureMessenger();

        // –ó–∞–≥—Ä—É–∑–∫–∞ libsodium –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', async () => {
            await messenger.init();
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML –∫–Ω–æ–ø–æ–∫
        function login() {
            messenger.login();
        }

        function sendMessage() {
            messenger.sendMessage();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
        document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('recipientInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('messageInput').focus();
            }
        });

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ID –ø–æ –∫–ª–∏–∫—É
        document.addEventListener('click', function(e) {
            if (e.target.id === 'myUserId') {
                messenger.copyUserId();
            }
        });

        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω - —Å–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º sidebar –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        function handleResize() {
            const sidebar = document.querySelector('.chat-sidebar');
            const mainArea = document.querySelector('.main-chat-area');
            
            if (window.innerWidth <= 768) {
                sidebar.style.display = 'none';
                mainArea.style.flex = '1';
            } else {
                sidebar.style.display = 'flex';
                mainArea.style.flex = '1';
            }
        }

        window.addEventListener('resize', handleResize);
        window.addEventListener('load', handleResize);
    </script>
</body>
</html>
